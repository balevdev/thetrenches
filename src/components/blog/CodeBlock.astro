---
interface Props {
  language?: string;
  filename?: string;
  showLineNumbers?: boolean;
}

const { language = '', filename, showLineNumbers = false } = Astro.props;
---

<div class="code-block" data-code-block>
  <div class="code-block__header">
    <div class="code-block__dots">
      <span class="code-block__dot code-block__dot--red"></span>
      <span class="code-block__dot code-block__dot--yellow"></span>
      <span class="code-block__dot code-block__dot--green"></span>
    </div>
    {filename && <span class="code-block__filename">{filename}</span>}
    {language && <span class="code-block__language">{language}</span>}
    <button class="code-block__copy" data-copy-button aria-label="Copy code">
      <svg class="code-block__copy-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
      </svg>
      <svg class="code-block__check-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 6 9 17l-5-5"></path>
      </svg>
      <span class="code-block__copy-text">Copy</span>
    </button>
  </div>
  <div class:list={['code-block__content', { 'code-block__content--line-numbers': showLineNumbers }]}>
    <slot />
  </div>
</div>

<style>
  .code-block {
    position: relative;
    margin: var(--space-8) 0;
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: 1px solid var(--border-medium);
  }

  .code-block__header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background-color: var(--bg-elevated);
    border-bottom: 1px solid var(--border-subtle);
  }

  .code-block__dots {
    display: flex;
    gap: var(--space-2);
  }

  .code-block__dot {
    width: 12px;
    height: 12px;
    border-radius: var(--radius-full);
  }

  .code-block__dot--red { background-color: #ff5f57; }
  .code-block__dot--yellow { background-color: #febc2e; }
  .code-block__dot--green { background-color: #28c840; }

  .code-block__filename {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--text-secondary);
  }

  .code-block__language {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    text-transform: uppercase;
    margin-left: auto;
  }

  .code-block__copy {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    margin-left: auto;
  }

  .code-block__filename + .code-block__copy,
  .code-block__language + .code-block__copy {
    margin-left: 0;
  }

  .code-block__copy:hover {
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .code-block__copy.copied {
    color: var(--color-success);
  }

  .code-block__check-icon {
    display: none;
  }

  .code-block__copy.copied .code-block__copy-icon {
    display: none;
  }

  .code-block__copy.copied .code-block__check-icon {
    display: block;
  }

  .code-block__content {
    background-color: var(--bg-code);
  }

  .code-block__content :global(pre) {
    margin: 0;
    padding: var(--space-5);
    border: none;
    border-radius: 0;
    background: transparent;
    overflow-x: auto;
  }

  .code-block__content :global(code) {
    background: none;
    border: none;
    padding: 0;
  }

  .code-block__content--line-numbers :global(pre) {
    counter-reset: line;
  }

  .code-block__content--line-numbers :global(.line::before) {
    counter-increment: line;
    content: counter(line);
    display: inline-block;
    width: 2em;
    margin-right: var(--space-4);
    text-align: right;
    color: var(--text-muted);
    user-select: none;
  }
</style>

<script>
  document.querySelectorAll('[data-code-block]').forEach(block => {
    const copyButton = block.querySelector('[data-copy-button]');
    const codeContent = block.querySelector('pre code, pre');

    if (copyButton && codeContent) {
      copyButton.addEventListener('click', async () => {
        const text = codeContent.textContent || '';

        try {
          await navigator.clipboard.writeText(text);
          copyButton.classList.add('copied');
          const textSpan = copyButton.querySelector('.code-block__copy-text');
          if (textSpan) textSpan.textContent = 'Copied!';

          setTimeout(() => {
            copyButton.classList.remove('copied');
            if (textSpan) textSpan.textContent = 'Copy';
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    }
  });
</script>
