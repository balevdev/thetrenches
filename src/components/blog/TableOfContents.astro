---
interface Props {
  headings: Array<{ depth: number; slug: string; text: string }>;
}

const { headings } = Astro.props;

// Filter to only h2 and h3
const tocHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);
---

{tocHeadings.length > 0 && (
  <nav class="toc" aria-label="Table of contents">
    <h4 class="toc__title">On this page</h4>
    <ul class="toc__list">
      {tocHeadings.map(heading => (
        <li class:list={['toc__item', { 'toc__item--nested': heading.depth === 3 }]}>
          <a href={`#${heading.slug}`} class="toc__link" data-toc-link>
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<style>
  .toc {
    position: sticky;
    top: calc(var(--header-height) + var(--space-8));
    max-height: calc(100vh - var(--header-height) - var(--space-16));
    overflow-y: auto;
    padding-right: var(--space-4);
  }

  .toc__title {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: var(--tracking-widest);
    color: var(--text-tertiary);
    margin: 0 0 var(--space-4);
  }

  .toc__list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc__item {
    margin-bottom: var(--space-1);
  }

  .toc__item--nested {
    padding-left: var(--space-4);
  }

  .toc__link {
    display: block;
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    padding: var(--space-1) var(--space-3);
    border-left: 2px solid transparent;
    text-decoration: none;
    transition: all var(--transition-fast);
    line-height: var(--leading-snug);
  }

  .toc__link:hover {
    color: var(--text-primary);
    background-color: var(--bg-secondary);
  }

  .toc__link.active {
    color: var(--accent-primary);
    border-left-color: var(--accent-primary);
    background-color: var(--accent-primary-muted);
  }
</style>

<script>
  const tocLinks = document.querySelectorAll('[data-toc-link]');
  const headings = document.querySelectorAll('h2[id], h3[id]');

  if (tocLinks.length > 0 && headings.length > 0) {
    const observerOptions = {
      rootMargin: '-80px 0px -80% 0px',
      threshold: 0,
    };

    let activeId = '';

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          activeId = entry.target.id;
          updateActiveLink();
        }
      });
    }, observerOptions);

    headings.forEach(heading => observer.observe(heading));

    function updateActiveLink() {
      tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href === `#${activeId}`) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    }

    // Initial active state
    if (headings.length > 0) {
      activeId = headings[0].id;
      updateActiveLink();
    }
  }
</script>
